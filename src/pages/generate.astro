---
import { GeneratePage } from "~/components/generate-page";
import Root from "../layouts/root.astro";
import { scrapeArticle } from "../lib/scrape-article";

const article = Astro.url.searchParams.get("article") || "";

/* check that we have a good url */
try {
  const url = new URL(article);
  if (url.hostname !== "theumdhare.com") throw new Error();
} catch (e) {
  return Astro.redirect("/?error");
}

const { title, author, image, imageCredits, content } =
  await scrapeArticle(article);

const imageURI = await fetch(image)
  .then((res) => res.arrayBuffer())
  .then((buf) => "data:image/;base64," + Buffer.from(buf).toString("base64"));
---

<Root>
  <GeneratePage
    defaultTitle={title}
    defaultArticleByline={author ?? ""}
    defaultImageByline={imageCredits ?? ""}
    articleLink={article}
    imageURI={imageURI}
    client:load
  >
    <!-- must render here, cannot pass Element[] as prop since it gets serialized -->
    {
      author
        ? content.slice(1).map((para) => <Fragment set:html={para.outerHTML} />)
        : content.map((para) => <Fragment set:html={para.outerHTML} />)
    }
  </GeneratePage>
</Root>
